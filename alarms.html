<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="https://passport.services.bergwacht-bayern.org/public/base.css">

    <script src="https://api.services.bergwacht-bayern.org/js/phoenix.js"></script>

    <script>
        const BASE_URL = "https://api.bergwacht-allgaeu.de";
        const WEBSOCKET_URL = "wss://api.bergwacht-allgaeu.de/socket";

        const URLPARAMS = new URLSearchParams(window.location.search);
        const JWT = URLPARAMS.get("jwt");

        function parseDate(str_date) {
            return new Date(Date.parse(str_date));
        }

        function getTableIndex(table, time, options) {
            const rows = table.rows;
            for (var i = 0; i < rows.length; i++) {
                if (parseDate(rows[i].cells[0].getAttribute("time")) < time) {
                    return i;
                }
            }
            return rows.length;
        }


        function getInputDate(date) {
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().slice(0, 16);
        }

        function openProtocol() {
            var tr = event.target.parentNode;
            console.log(tr);
            const extid = tr.getAttribute("extid");

            location.href = "/protocol?jwt=" + JWT + "&extid=" + extid, "_blank";
        }

        function appendAlarm(alarm) {
            const table = document.getElementById("events-rows");
            const time = parseDate(alarm.originated_at);

            var index = getTableIndex(table, time, options);
            var row = table.insertRow(index);

            row.setAttribute("onclick", "openProtocol()");
            row.setAttribute("extid", alarm.extid);

            var timestampCell = row.insertCell();
            var keywordCell = row.insertCell();
            var descriptionCell = row.insertCell();

            timestampCell.innerHTML = time.toLocaleString("de-DE", options);
            timestampCell.setAttribute("time", getInputDate(time));
            keywordCell.innerHTML = alarm.payload.data.keyword;
            descriptionCell.innerHTML = alarm.message;
            handledIds.push(alarm.extid);
        }

        function loadLatestOpenAlarms() {
            const now = new Date();
            const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const originated_after = URLPARAMS.get("date") ?? twentyFourHoursAgo.toISOString();

            const queryParams = new URLSearchParams({
                // subkind: "OPEN",
                originated_after: originated_after,
            });

            const url = BASE_URL + "/api/eventhub/alarms?" + queryParams.toString();

            fetch(url, {
                method: "GET", headers: {
                    "Content-Type": "application/vnd.api+json",
                    "Accept": "application/vnd.api+json",
                    "Authorization": "Bearer " + JWT
                }
            }).then(response => response.json()).then(data => {
                data.data.forEach(alarm => {
                    appendAlarm(alarm.attributes);
                });
            }).catch(error => { console.log(error); });
        }

        const options = {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
        };

        let handledIds = [];

        const socket = new Phoenix.Socket(WEBSOCKET_URL, {
            params: { token: JWT },
        });

        socket.connect();

        const channel = socket.channel("eventhub", {});

        channel.on("events.update", (payload) => {
            console.log("Received", payload);

            const events = payload.events;

            if (events) {
                events.forEach(event => {
                    if (!handledIds.includes(event.extid)) {
                        appendAlarm(event);
                    }
                });
            }
        });

        channel
            .join()
            .receive("ok", (resp) => {
                console.log("Joined successfully", resp);
            })
            .receive("error", (resp) => {
                console.log("Unable to join", resp);
            });

        loadLatestOpenAlarms();
    </script>

    <style>
        table {
            table-layout: fixed;
            width: 100%;
            margin-top: 1em;
        }

        th {
            text-align: left;
        }
    </style>
</head>

<body>
    <div id="fullscreen">
        <div class="content">
            <h1>Letzte Alarme</h1>

            <table style="width: 95%">
                <thead>
                    <tr>
                        <th style="width: 20%">Alarmzeit</th>
                        <th style="width: 30%">Stichwort</th>
                        <th style="width: 50%">Alarmtext</th>
                    </tr>
                </thead>
                <tbody id="events-rows">
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>