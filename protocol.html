<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="https://passport.services.bergwacht-bayern.org/public/base.css">

  <script src="https://api.services.bergwacht-bayern.org/js/phoenix.js"></script>

  <script>
    function parseDate(str_date) {
      return new Date(Date.parse(str_date));
    }

    function getInputDate(date) {
      date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
      return date.toISOString().slice(0, 16);
    }

    function getTableIndex(table, time, options) {
      const rows = table.rows;
      for (var i = 0; i < rows.length; i++) {
        if (parseDate(rows[i].cells[0].getAttribute("time")) < time) {
          return i;
        }
      }
      return rows.length;
    }
    function addTableRow(table, time, from, description, action, edit, uuid) {
      const options = {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      };
      index = getTableIndex(table, time, options);

      var row = table.insertRow(index);
      var timestampCell = row.insertCell();
      var originCell = row.insertCell();
      var descriptionCell = row.insertCell();
      var actionCell = row.insertCell();
      timestampCell.innerHTML = time.toLocaleString("de-DE", options);
      timestampCell.setAttribute("time", time.toISOString());
      originCell.innerHTML = from;
      descriptionCell.innerHTML = description;
      actionCell.innerHTML = action;
      actionCell.setAttribute("uuid", uuid);
      var editCell = row.insertCell();
      editCell.className = "no-print";

      editCell.innerHTML = "<button onClick=\"editAction()\">bearbeiten</button>";
      editCell.setAttribute("time", getInputDate(time));
      editCell.setAttribute("uuid", uuid);
      if (edit) {
        editCell.innerHTML = "<button onClick=\"editAction()\">bearbeiten</button> <button onClick=\"editManualRow()\">-</button>";
      }
    }

    function addManualRow() {
      const table = document.getElementById("events-rows");
      const time = document.getElementById("manualTime");
      const from = document.getElementById("manualFrom");
      const message = document.getElementById("manualMessage");
      const action = document.getElementById("manualAction");
      let manualRows = window.localStorage.getItem(extid + "-manual") ? JSON.parse(window.localStorage.getItem(extid + "-manual")) : [];
      const uuid = crypto.randomUUID();
      addTableRow(table, parseDate(time.value), from.value, message.value, action.value, true, uuid);
      manualRows.push({ "time": parseDate(time.value), "from": from.value, "message": message.value, "action": action.value, "uuid": uuid });
      window.localStorage.setItem(extid + "-manual", JSON.stringify(manualRows));
      time.value = "";
      from.value = "";
      message.value = "";
      action.value = "";
    }

    function editAction() {
      var td = event.target.parentNode;
      td.innerHTML = td.innerHTML.replace("editAction", "saveAction").replace("bearbeiten", "speichern");
      var tr = td.parentNode; // the row to be removed
      const cells = tr.cells;
      var textarea = document.createElement("textarea");
      textarea.id = "area" + td.getAttribute("uuid");
      textarea.value = cells[3].innerHTML;;
      cells[3].innerHTML = "";
      cells[3].appendChild(textarea);
      document.getElementById("area" + td.getAttribute("uuid")).focus();
    }

    function saveAction() {
      var td = event.target.parentNode;
      td.innerHTML = td.innerHTML.replace("saveAction", "editAction").replace("speichern", "bearbeiten");
      var tr = td.parentNode; // the row to be removed
      const cells = tr.cells;
      const textarea = document.getElementById("area" + td.getAttribute("uuid"));
      const action = textarea.value;
      let autoRows = window.localStorage.getItem(extid + "-auto") ? JSON.parse(window.localStorage.getItem(extid + "-auto")) : [];
      let row = autoRows.find(row => row.uuid === td.getAttribute("uuid"));
      autoRows = autoRows.filter(row => row.uuid !== td.getAttribute("uuid"));
      row.action = action;
      autoRows.push(row);
      window.localStorage.setItem(extid + "-auto", JSON.stringify(autoRows));
      cells[3].removeChild(textarea);
      cells[3].innerHTML = action;
    }

    function editManualRow() {
      // event.target will be the input element.
      var td = event.target.parentNode;
      var tr = td.parentNode; // the row to be removed
      const cells = tr.cells;
      const time = document.getElementById("manualTime");
      const from = document.getElementById("manualFrom");
      const message = document.getElementById("manualMessage");
      const action = document.getElementById("manualAction");
      time.value = td.getAttribute("time");
      from.value = cells[1].innerHTML;
      message.value = cells[2].innerHTML;
      action.value = cells[3].innerHTML.startsWith("<textarea") ? cells[3].firstChild.value : cells[3].innerHTML;
      let manualRows = JSON.parse(window.localStorage.getItem(extid + "-manual"));
      manualRows = manualRows.filter(row => row.uuid === td.getAttribute("uuid"));
      window.localStorage.setItem(extid + "-manual", JSON.stringify(manualRows));
      tr.parentNode.removeChild(tr);
    }

    function onFocus() {
      const time = document.getElementById("manualTime");
      if (time.value === "") {
        var now = new Date();
        time.value = getInputDate(now);
      }

    }

    function addAutoRow(table, time, from, message) {
      let autoRows = window.localStorage.getItem(extid + "-auto") ? JSON.parse(window.localStorage.getItem(extid + "-auto")) : [];
      const uuid = crypto.randomUUID();
      addTableRow(table, time, from, message, "", false, uuid);
      autoRows.push({ "time": time, "from": from, "message": message, "action": "", "uuid": uuid });
      window.localStorage.setItem(extid + "-auto", JSON.stringify(autoRows));
    }

    function handleKeyword(event) {
      if (event.subkind === "NEW") {
        const keyword = document.getElementById("keyword");
        keyword.innerHTML = "Einsatzprotokoll: " + event.payload.data.keyword;
      }
    }

    function handleEnd(event, table, end, addRow) {
      if (end === false) {
        if (event.payload.data.alarmProtocol && event.payload.data.alarmProtocol.find(status => status.type === "CLOSED")) {
          const index = event.payload.data.alarmProtocol.findIndex(status => status.type === "CLOSED");
          if (addRow) addAutoRow(table, new Date(event.payload.data.alarmProtocol[index].timestamp), "ILS -> EL", "Einsatz abgeschlossen");
          end = true;
        }
      }
      return end;
    }


    function handleMessage(event, table, message, addRow) {
      if (message !== undefined) {
        if (event.message !== message.text) {
          message["text"] = event.message;
          message["time"] = parseDate(event.originated_at);
          if (addRow) addAutoRow(table, message["time"], "ILS -> EL", "Meldung: " + message["text"]);
          const messageId = document.getElementById("message");
          messageId.innerHTML = "Meldung: " + message["text"];
        }
      }
      else {
        message = {};
        message["text"] = event.message;
        message["time"] = parseDate(event.originated_at);
        if (addRow) addAutoRow(table, message["time"], "ILS -> EL", "Meldung: " + message["text"]);
        const messageId = document.getElementById("message");
        messageId.innerHTML = "Meldung: " + message["text"];
      }
      return message;
    }

    function handleCoordinates(event, table, coordinates, addRow) {
      if (coordinates !== undefined) {
        if (event.latitude !== coordinates.latitude || event.longitude !== coordinates.longitude) {
          coordinates["latitude"] = event.latitude;
          coordinates["longitude"] = event.longitude;
          coordinates["time"] = parseDate(event.originated_at);
          if (addRow) addAutoRow(table, coordinates["time"], "ILS -> EL", "Koordinaten: " + coordinates["latitude"] + " / " + coordinates["longitude"]);
          const coordinatesId = document.getElementById("coordinates");
          coordinatesId.innerHTML = "Koordinaten: " + "<a href=\"https://geoportal.bayern.de/bayernatlas/?E=" + coordinates["longitude"] + "&N=" + coordinates["latitude"] + "&zoom=10&crosshair=marker&lang%3Dde&topic=ba&catalogNodes=11&bgLayer=tk&lang=de\">" + coordinates["latitude"] + " / " + coordinates["longitude"] + "</a>";
        }
      }
      else {
        coordinates = {};
        coordinates["latitude"] = event.latitude;
        coordinates["longitude"] = event.longitude;
        coordinates["time"] = parseDate(event.originated_at);
        if (addRow) addAutoRow(table, coordinates["time"], "ILS -> EL", "Koordinaten: " + coordinates["latitude"] + " / " + coordinates["longitude"]);
        const coordinatesId = document.getElementById("coordinates");
        coordinatesId.innerHTML = "Koordinaten: " + "<a href=\"https://geoportal.bayern.de/bayernatlas/?E=" + coordinates["longitude"] + "&N=" + coordinates["latitude"] + "&zoom=10&crosshair=marker&lang%3Dde&topic=ba&catalogNodes=11&bgLayer=tk&lang=de\">" + coordinates["latitude"] + " / " + coordinates["longitude"] + "</a>";
      }
      return coordinates;
    }

    function handleCaller(event, table, caller, addRow) {
      if (event.payload.data.caller === undefined) {
        return caller;
      }
      if (caller !== undefined) {
        if (event.payload.data.caller.contact !== caller.contact || event.payload.data.caller.name !== caller.name) {
          caller["contact"] = event.payload.data.caller.contact;
          caller["name"] = event.payload.data.caller.name;
          caller["time"] = parseDate(event.originated_at);
          if (addRow) addAutoRow(table, coordinates["time"], "ILS -> EL", "Rückrufnummer: " + caller["name"] + ": " + caller["contact"]);
          const callerId = document.getElementById("caller");
          callerId.innerHTML = "Rückrufnummer: " + caller["name"] + ": " + caller["contact"];
        }
      }
      else {
        caller = {};
        caller["contact"] = event.payload.data.caller.contact;
        caller["name"] = event.payload.data.caller.name;
        caller["time"] = parseDate(event.originated_at);
        if (addRow) addAutoRow(table, coordinates["time"], "ILS -> EL", "Rückrufnummer: " + caller["name"] + ": " + caller["contact"]);
        const callerId = document.getElementById("caller");
        callerId.innerHTML = "Rückrufnummer: " + caller["name"] + ": <a href=\"tel:" + caller["contact"] + "\">" + caller["contact"] + "</a>";
      }
      return caller;
    }

    function handleVehicles(event, table, vehicles, addRow) {
      if (event.payload.data.vehicles === undefined) {
        return vehicles;
      }
      event.payload.data.vehicles.forEach(vehicle => {
        if (!vehicles.includes(vehicle.name)) {
          vehicles.push(vehicle.name);
          if (addRow) addAutoRow(table, new Date(vehicle.alarmedTime), "ILS -> EL", "Neues Einsatzmittel: " + vehicle.name);
        }
      })
      return vehicles;
    }

    function handleVehicleStatus(event, table, vehicleStatus, addRow) {
      if (event.payload.data.vehicleStatusHistory === undefined) {
        return vehicleStatus;
      }
      event.payload.data.vehicleStatusHistory.forEach(vehicle => {
        if (vehicle.statusList) {
          vehicle.statusList.forEach(status => {
            if (vehicleStatus[vehicle.name]) {
              if (!vehicleStatus[vehicle.name].includes(status.timestamp)) {
                vehicleStatus[vehicle.name].push(status.timestamp);
                if (addRow) addAutoRow(table, new Date(status.timestamp), vehicle.name + " -> ILS", vehicle.name + ": Status: " + status.status);
              }
            } else {
              vehicleStatus[vehicle.name] = [status.timestamp];
              if (addRow) addAutoRow(table, new Date(status.timestamp), vehicle.name + " -> ILS", vehicle.name + ": Status: " + status.status);
            }
          })
        }
      })
      return vehicleStatus;
    }

    function clearProtocol() {
      if (confirm("Den Einsatz wirklich abschließen?\nAlle Einträge werden gelöscht!")) {
        const table = document.getElementById("events-rows");
        const protocol = [];
        for (let row of table.rows) {
          protocol.push({ time: row.cells[0].innerHTML, origin: row.cells[1].innerHTML, message: row.cells[2].innerHTML });
        }
        const body = { data: { attributes: { payload: { 'bwb:accounting': { protocol: protocol } } } } }
        fetch("https://api.services.bergwacht-bayern.org/api/eventhub/alarms/" + extid, { method: "PATCH", headers: { "Content-Type": "application/vnd.api+json", "Accept": "application/vnd.api+json", "Authorization": "Bearer " + jwt }, body: JSON.stringify(body) }).then(response => response.json()).then(data => {
          console.log(data); window.localStorage.removeItem(extid);
          window.open('https://office.bergwacht-bayern.de', '_self', '');
        }).catch(error => { console.log(error); alert("Fehler, bitte erneut versuchen!") });
      }
    }

    const jwt = new URLSearchParams(window.location.search).get("jwt");

    const extid = new URLSearchParams(window.location.search).get("extid");

    const socket = new Phoenix.Socket("wss://api.services.bergwacht-bayern.org/socket", {
      params: { token: jwt },
    });

    socket.connect();

    const channel = socket.channel("eventhub", {});

    var message = undefined;
    var coordinates = undefined;
    var caller = undefined;
    var vehicles = [];
    var vehicleStatus = {};
    var end = false;
    let manualRows = window.localStorage.getItem(extid + "-manual") ? JSON.parse(window.localStorage.getItem(extid + "-manual")) : [];
    let autoRows = window.localStorage.getItem(extid + "-auto") ? JSON.parse(window.localStorage.getItem(extid + "-auto")) : [];
    let handledIds = window.localStorage.getItem(extid + "-handled") ? JSON.parse(window.localStorage.getItem(extid + "-handled")) : [];

    channel.on("events.update", (payload) => {
      console.log("Received", payload);

      const events = payload.events;

      if (events) {
        const table = document.getElementById("events-rows");
        events.forEach(event => {
          if (!handledIds.includes(event.id)) {
            handleKeyword(event);
            message = handleMessage(event, table, message, true);
            coordinates = handleCoordinates(event, table, coordinates, true);
            caller = handleCaller(event, table, caller, true);
            vehicles = handleVehicles(event, table, vehicles, true);
            vehicleStatus = handleVehicleStatus(event, table, vehicleStatus, true);
            end = handleEnd(event, table, end, true);
            handledIds.push(event.id);
            window.localStorage.setItem(extid + "-handled", JSON.stringify(handledIds));
          } else {
            handleKeyword(event);
            message = handleMessage(event, table, message, false);
            coordinates = handleCoordinates(event, table, coordinates, false);
            caller = handleCaller(event, table, caller, false);
            vehicles = handleVehicles(event, table, vehicles, false);
            vehicleStatus = handleVehicleStatus(event, table, vehicleStatus, false);
            end = handleEnd(event, table, end, false);
          }
        });
      }
    });

    channel
      .join()
      .receive("ok", (resp) => {
        console.log("Joined successfully", resp);

        if (extid) {
          channel.push("catchup", {
            extid: extid
          })
        }
      })
      .receive("error", (resp) => {
        console.log("Unable to join", resp);
      });
    window.onload = function () {
      const table = document.getElementById("events-rows");
      autoRows.forEach(row => addTableRow(table, parseDate(row.time), row.from, row.message, row.action, false, row.uuid));
      manualRows.forEach(row => addTableRow(table, parseDate(row.time), row.from, row.message, row.action, true, row.uuid));
    }
  </script>

  <style>
    table {
      table-layout: fixed;
      width: 100%;
      margin-top: 1em;
    }

    th {
      text-align: left;
    }

    tr:nth-child(even) {
      background-color: #eeeeee;
    }

    @media print {

      .no-print,
      .no-print * {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <div id="fullscreen">
    <div class="content">
      <h1 id="keyword">Einsatzprotokoll:</h1><button onclick="window.print();return false;" class="no-print"
        style="float: right; margin-right: 5%;">Protokoll drucken</button>
      <h3 id="caller">Rückrufnummer:</h3><button onclick="clearProtocol()" class="no-print"
        style="float: right; margin-right: 5%;">Protokoll abschließen</button>
      <h3 id="coordinates">Koordinaten:</h3>
      <h3 id="message">Meldung:</h3>


      <table style="width: 95%">
        <thead>
          <tr>
            <th style="width: 20%">Zeit<br><input type="datetime-local" id="manualTime" class="no-print"></th>
            <th style="width: 20%">Von -> An<br><input type="text" id="manualFrom" onfocus="onFocus()" class="no-print">
            </th>
            <th style="width: 25%">Meldung<br><textarea id="manualMessage" onfocus="onFocus()"
                class="no-print"></textarea></th>
            <th style="width: 25%">Maßnahmen/Sonstiges<br><textarea id="manualAction" onfocus="onFocus()"
                class="no-print"></textarea></th>
            <th style="width: 20%" class="no-print">Aktion<br><button onClick="addManualRow()">+</button></th>
          </tr>
        </thead>
        <tbody id="events-rows">
        </tbody>
      </table>
    </div>
  </div>
</body>

</html>